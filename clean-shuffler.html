<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OracleFlow</title>
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />

<style>
:root{
  --brand-blue:#277bfa;
  --brand-green:#1e9b6e;
  --brand-orange:#ff9e40;
  --card-aspect:13/20;
  --stagger-step:35ms;
  --stagger-cap:8;
}

/* === layout & controls === */
body{margin:0;min-height:100vh;background:#ecf3fd;
     display:flex;flex-direction:column;align-items:center;
     font-family:system-ui,sans-serif}
.deck-label{margin:28px 0 10px;font:700 2.1rem/1 system-ui,sans-serif;
            color:#1e355d;letter-spacing:1px;text-align:center}
.controls{margin:10px 0 0;display:flex;flex-wrap:wrap;align-items:center;
          justify-content:center;gap:.7em;font-size:1.05rem}
.controls label{font-weight:500;color:#224}
select{padding:4px 10px;min-width:56px;font-size:1rem;border:1.5px solid #b9c7e0;
        border-radius:7px;background:#f7faff;outline:none;transition:border-color .18s}
select:focus{border-color:var(--brand-blue)}
button{padding:7px 22px;font-size:1rem;font-weight:500;color:#fff;border:none;
       border-radius:8px;cursor:pointer;box-shadow:0 2px 10px 0 #bed3fa22;
       transition:background .2s}
#collapseBtn{background:var(--brand-blue)}
#shuffleBtn {background:var(--brand-green)}
#resetBtn   {background:var(--brand-orange)}
button:disabled{background:#b8b9c8;cursor:not-allowed}

/* === deck wrapper === */
.deck-wrapper{
  display: flex;
  align-items: flex-start;
  justify-content: center;
  gap: 48px;
  width: 100%;
  max-width: none;
  padding-inline: 0;
  min-height: 280px;
  padding-top: clamp(12px, 5vh, 60px);
  position: relative;
  transition: gap var(--fan-ms-expand) var(--fan-ease-expand);
}

/* === Collapsed mode: shared width + safe height === */
.deck-wrapper.collapsed-mode { 
  gap: 16px; /* give breathing room */
}

.deck-wrapper.collapsed-mode .discard-area{
  /* Use min-height so larger cards don't push up into the buttons */
  min-height: calc(130px / var(--card-aspect) + 40px); /* card + bottom padding + badges */
  height: auto;
  width: 130px;
  justify-content: flex-end;
  padding-bottom: 20px;
  margin-top: 0; /* ensure Discard column doesn't sit higher than Deck */
}

/* Discard stack fills its column in collapsed mode */
.deck-wrapper.collapsed-mode .discard-stack{ 
  width: 100%; 
}

/* Kill per-card shadows when the deck is collapsed */
.fan-tableau.is-collapsed .fan-card{
  box-shadow: none !important;
}



/* === tableau & rows === */
.fan-tableau{position:relative;width:99vw;max-width:1100px;min-height:250px;
             margin-top:18px;display:flex;flex-direction:column;align-items:center;
             user-select:none}
.fan-row{position:relative;width:100%;height:22vw;max-height:220px;min-height:120px;
         margin-top:-13vw;pointer-events:none}
.fan-row:first-child{margin-top:0}

/* === card (unchanged except for cascade) === */
.fan-card{
  --tx:0;--ty:0;--rot:0deg;
  --stackX:0;--stackY:0;--stackR:0deg;
  --row:0;

  position:absolute;bottom:0;left:0;width:var(--cw);aspect-ratio:var(--card-aspect);
  min-width:55px;max-width:130px;border-radius:16px;background:transparent;
  overflow:hidden;border:none;cursor:pointer;pointer-events:auto;
  padding:0;margin:0;

  transition:
      left      .85s cubic-bezier(.25,.8,.35,1),
      transform .85s cubic-bezier(.25,.8,.35,1),
      box-shadow .18s,filter .18s;
  transition-delay:calc(min(var(--row), var(--stagger-cap)) * var(--stagger-step));

  transform:translate(var(--tx),var(--ty)) rotate(var(--rot));
  box-shadow:0 4px 16px 2px rgba(60,70,120,.16);
}
.fan-tableau.is-collapsed .fan-card{
  transform:translate(var(--stackX),var(--stackY)) rotate(var(--stackR));
  box-shadow:0 2px 8px 0 rgba(60,70,120,.08);
}
.fan-card img{width:100%;height:100%;object-fit:cover;display:block;
              user-select:none;pointer-events:none;border-radius:inherit}
.fan-card .num{position:absolute;top:4px;left:6px;padding:0 4px;border-radius:4px;
               background:#1e355de6;color:#fff;font-size:.70rem;font-weight:600}
.fan-card.is-lifted{filter:brightness(1.07) saturate(1.13);
                    box-shadow:0 16px 40px 10px rgba(39,123,250,.17);
                    transform:translate(var(--tx),calc(var(--ty) - 10px))
                              rotate(var(--rot)) scale(1.04)}
.fan-card:focus-visible{outline:2px solid var(--brand-blue)}

/* === shuffle riffle === */
@keyframes riffle{
  0%   {transform:translate(var(--stackX),var(--stackY)) rotate(calc(var(--stackR) - 3deg));}
  50%  {transform:translate(calc(var(--stackX) + 6px),calc(var(--stackY) + 4px)) rotate(calc(var(--stackR) + 3deg));}
  100% {transform:translate(var(--stackX),var(--stackY)) rotate(var(--stackR));}
}
.is-shuffling .fan-card{animation:riffle .3s ease-in-out}

/* === deck shake animation === */
@keyframes deckShake {
  0%{ transform:translateX(0); }
  20%{ transform:translateX(-2px); }
  40%{ transform:translateX(2px); }
  60%{ transform:translateX(-2px); }
  80%{ transform:translateX(2px); }
  100%{ transform:translateX(0); }
}

.deck-shake {
  animation: deckShake 0.5s ease infinite;
}

/* === discard pile === */
.discard-area{
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  gap:6px;
  cursor:pointer; 
  user-select:none; 
  margin-top:18px;
  opacity: 0 !important;
  transform: translateX(20px) !important;
  transition: opacity 0.15s ease, transform 0.15s ease;
  pointer-events: none !important;
  position: absolute !important;
  left: 50% !important;
  top: 0;
  z-index: 10;
  width: 130px;
}

/* Show discard pile only when column is in collapsed mode */
.deck-wrapper.collapsed-mode .discard-area {
  opacity: 1 !important;
  transform: none !important;
  pointer-events: auto !important;
  position: static !important;
  left: auto !important;
}

/* Hide discard pile during shuffle animation when starting from fanned mode */
.deck-wrapper.collapsed-mode.shuffling .discard-area {
  opacity: 0 !important;
  pointer-events: none !important;
}

.discard-stack{
  width:130px; 
  aspect-ratio:var(--card-aspect); 
  border-radius:16px;
  background:#d8d8d8 center/cover; 
  box-shadow:0 6px 16px rgba(0,0,0,.25);
  opacity:.25; 
  transition:transform .25s, opacity .25s, outline-offset .2s;
}

.discard-area.has-cards .discard-stack{ opacity:1 }
.discard-area.hover .discard-stack{ outline:3px dashed var(--brand-blue); outline-offset:4px }

.discard-badge, .deck-badge{
  padding:2px 10px; 
  border-radius:14px; 
  background:#1e355d; 
  color:#fff;
  font-weight:600; 
  font-size:.9rem; 
  min-width:36px; 
  text-align:center;
  transform:scale(0); 
  transition:transform .25s;
}

.discard-area.has-cards .discard-badge{ transform:scale(1) }
.deck-badge{ transform:scale(1) }

.discard-info {
  font-weight:600; 
  font-size:1.1rem; 
  color:#1e355d;
}

/* === selected strip === */
.selected-area{margin:32px 0 40px;width:99vw;max-width:1100px;
               display:flex;flex-wrap:wrap;gap:16px}
.selected-card{display:flex;flex-direction:column;align-items:center}
.selected-card img{width:130px;aspect-ratio:var(--card-aspect)}
.selected-card .label{margin-top:6px;font-weight:600;color:#1e355d}

/* === shuffle message === */
.shuffle-message {
  width:100%; 
  text-align:center; 
  font-weight:bold; 
  background:transparent; 
  color:transparent; 
  margin-bottom:10px; 
  min-height:40px; 
  display:block; 
  padding:10px; 
  box-sizing:border-box;
  margin-bottom: 0;
  transition: background-color 0.3s ease, color 0.3s ease;
}
.shuffle-message.active {
  background:#c9f1ff; 
  color:#333;
}
#shuffleText { display:inline-block; }

/* === responsive tweaks === */
@media(max-width:900px){.deck-label{font-size:1.55rem}.controls{font-size:.98rem}.fan-row{margin-top:-18vw}}
@media(max-width:650px){.deck-label{font-size:1.13rem}.fan-tableau{min-height:120px}
  .fan-row{min-height:52px;max-height:120px;margin-top:-19vw}
  .fan-card{min-width:35px;max-width:80px}.selected-card img{width:80px}}
@media(max-width:480px){.fan-row{margin-top:-23vw}.fan-card{min-width:28px;max-width:60px}.selected-card img{width:60px}}
</style>
</head>

<body>
<h1 class="deck-label">OracleFlow</h1>

<div class="controls">
  <label for="num-cards">Cards:</label>
  <select id="num-cards"></select>
  <button id="collapseBtn">Collapse</button>
  <button id="shuffleBtn">Shuffle</button>
  <button id="resetBtn">Reset</button>
  <label><input type="checkbox" id="enableDiscard" checked /> Discard Pile</label>
</div>

<div id="shuffleMessage" class="shuffle-message">
  <span id="shuffleText"></span>
</div>

<div class="deck-wrapper">
  <div class="fan-tableau" id="fan-tableau"></div>
  <div class="discard-area" id="discardArea" aria-label="Discard pile" tabindex="0">
    <div class="discard-stack" id="discardStack"></div>
    <div class="discard-badge" id="discardCount" aria-live="polite">0</div>
    <div class="discard-info">Discard</div>
  </div>
</div>
<div class="selected-area" id="selectedArea"></div>

<script type="module">
/* ---------- constants ---------- */
const IMG       = 'https://storage.googleapis.com/msgsndr/n161UT4gIrAicPzCWPho/media/678322ce69da5f661321e688.png';
const PER_ROW   = 80;
const BASE_DUR  = 850;
const STAGGER_MS= 35 * 8;
const TRANS_MS  = BASE_DUR + STAGGER_MS;
const RIFFLE_MS = 300;

/* ---------- DOM refs ---------- */
const tableau   = document.getElementById('fan-tableau');
const selected  = document.getElementById('selectedArea');
const numSel    = document.getElementById('num-cards');
const collapseB = document.getElementById('collapseBtn');
const shuffleB  = document.getElementById('shuffleBtn');
const resetB    = document.getElementById('resetBtn');
const pileArea  = document.getElementById('discardArea');
const pileStack = document.getElementById('discardStack');
const discardCount = document.getElementById('discardCount');
const enableDiscard = document.getElementById('enableDiscard');
const deckWrap = document.querySelector('.deck-wrapper');

/* ---------- state ---------- */
let collapsed = false;
let deck      = [];
let discard   = [];
let allowDiscard = true;
let isShuffling = false; // Track if we're in shuffle animation

/* ---------- dropdown fill ---------- */
for(let i=1;i<=80;i++){
  numSel.insertAdjacentHTML('beforeend', `<option value="${i}"${i===10?' selected':''}>${i}</option>`);
}

/* ---------- helpers (unchanged) ---------- */
const spanDeg = n => n<=10 ? 12 : n>=30 ? 4 : 12 - 8*(n-10)/20;

function rowGeom(cnt,cw,W){ /* ... unchanged ... */ 
  const span=spanDeg(cnt), min=-span/2, max=span/2;
  const spread=cnt===1?0:(W-cw)/(cnt-1);
  const vR=Math.max(cw*0.09,8);
  const center=((cnt-1)*spread)/2;
  return Array.from({length:cnt},(_,i)=>{
    const rot=cnt===1?0:min+(max-min)*i/(cnt-1);
    return{left:i*spread,tx:0,ty:-Math.sin(rot*Math.PI/180)*vR,rot,
           stackX:center-i*spread,stackY:0,stackR:0};
  });
}
const apply=(card,g)=>{ /* ... unchanged ... */ 
  card.style.left=`${g.left}px`;
  card.style.setProperty('--tx',`${g.tx}px`);
  card.style.setProperty('--ty',`${g.ty}px`);
  card.style.setProperty('--rot',`${g.rot}deg`);
  card.style.setProperty('--stackX',`${g.stackX}px`);
  card.style.setProperty('--stackY',`${g.stackY}px`);
  card.style.setProperty('--stackR',`${g.stackR}deg`);
};
const updateZ=()=>document.querySelectorAll('.fan-row').forEach((row,r)=>
  [...row.children].sort((a,b)=>a.offsetLeft-b.offsetLeft)
    .forEach((c,i)=>c.style.zIndex=r*PER_ROW+i));
const tidyRows=()=>{const W=tableau.offsetWidth;
  document.querySelectorAll('.fan-row').forEach((row,i)=>{
    row.style.marginTop=i?(W<600?'-20vw':'-13vw'):'0';
  });
};

const updateCounts=()=>{
  discardCount.textContent = discard.length;
  const has = discard.length > 0;
  pileArea.classList.toggle('has-cards', has);
  if (has) pileStack.setAttribute('draggable','true');
  else     pileStack.removeAttribute('draggable');
};

/* ---------- buildFan, recalc, toggle, shuffle (unchanged) ---------- */
function buildFan(){ /* ... unchanged except row var assignment ... */ 
  tableau.innerHTML='';
  const W=tableau.offsetWidth, rows=Math.ceil(deck.length/PER_ROW);
  for(let r=0;r<rows;r++){
    const nums=deck.slice(r*PER_ROW,(r+1)*PER_ROW);
    const row=document.createElement('div');
    row.className='fan-row'; tableau.appendChild(row);
    const cw=Math.max(Math.min(W/10,130),Math.min(W/nums.length,200));
    row.style.setProperty('--cw',`${cw}px`);
    rowGeom(nums.length,cw,W).forEach((g,i)=>{
      const n=nums[i];
      const card=document.createElement('button');
      card.type='button';
      card.className='fan-card'; 
      card.dataset.num=n;
      card.setAttribute('role', 'listitem');
      card.setAttribute('aria-label', `Card ${n}`);
      // Force refresh to ensure button elements are created
      card.style.setProperty('--row',r);
      apply(card,g);
      card.innerHTML=`<img src="${IMG}" alt="Card ${n}"><span class="num">${n}</span>`;
      ['mouseenter','focus'].forEach(evt=>card.addEventListener(evt,()=>!collapsed&&card.classList.add('is-lifted')));
      ['mouseleave','blur' ].forEach(evt=>card.addEventListener(evt,()=>card.classList.remove('is-lifted')));
      card.addEventListener('click',()=>{card.remove(); deck=deck.filter(x=>x!==n);
        selected.insertAdjacentHTML('beforeend',
          `<div class="selected-card"><img src="${IMG}" style="width:130px"><div class="label">Card ${n}</div></div>`);});
      
      // Right-click to discard
      card.addEventListener('contextmenu',(e)=>{
        e.preventDefault();
        if (allowDiscard) {
          toDiscard(n, card);
        }
      });
      row.appendChild(card);
    });
  }
  tidyRows(); updateZ();
}
function recalc(){ /* unchanged */ 
  const W=tableau.offsetWidth;
  document.querySelectorAll('.fan-row').forEach(row=>{
    const cards=[...row.children], cw=parseFloat(getComputedStyle(row).getPropertyValue('--cw'));
    const geom=rowGeom(cards.length,cw,W);
    cards.forEach((c,i)=>apply(c,geom[i]));
  }); tidyRows(); updateZ();
}
const toggle=()=>{
  if(!collapsed) recalc();
  tableau.classList.toggle('is-collapsed'); 
  deckWrap.classList.toggle('collapsed-mode'); // Add this line
  collapsed=!collapsed;
  collapseB.textContent=collapsed?'Fan Out':'Collapse';
};
const shuffleArr=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}};

// Enhanced shuffle function with messages and deck shake
function shuffleDeck(onComplete) {
  const shuffleMsg = document.getElementById('shuffleMessage');
  const shuffleText = document.getElementById('shuffleText');
  
  // Show shuffle message
  shuffleMsg.classList.add('active');
  shuffleText.textContent = "Shuffling Deck...";
  
  // Add deck shake animation
  tableau.classList.add('deck-shake');
  
  // Cycle through shuffle messages
  const messages = ["Shuffling Deck...", "Cutting Deck...", "Mixing Cards..."];
  let msgIndex = 0;
  const textInterval = setInterval(() => {
    msgIndex = (msgIndex + 1) % messages.length;
    shuffleText.textContent = messages[msgIndex];
  }, 600);
  
  // Shuffle the deck
  shuffleArr(deck);
  
  setTimeout(() => {
    clearInterval(textInterval);
    tableau.classList.remove('deck-shake');
    shuffleText.textContent = "Shuffling Complete";
    
    // Rebuild the fan immediately
    buildFan();
    
    // Hide message quickly
    setTimeout(() => {
      shuffleMsg.classList.remove('active');
      shuffleText.textContent = '';
    }, 500);
    
    if (typeof onComplete === 'function') {
      onComplete();
    }
  }, 1500);
}

// Discard functionality
function toDiscard(cardNum, el) {
  if (!allowDiscard) return;
  
  // Remove from deck
  deck = deck.filter(x => x !== cardNum);
  // Add to discard
  discard.push(cardNum);
  
  // Remove the card element
  el.remove();
  
  // Update counts
  updateCounts();
  
  // Rebuild fan if needed
  if (!collapsed) buildFan();
}

function restorePile() {
  if (!allowDiscard || !discard.length) return;
  
  // Move top card from discard back to deck
  const cardNum = discard.pop();
  deck.push(cardNum);
  
  // Rebuild fan
  buildFan();
  updateCounts();
}

/* ---------- button actions ---------- */
collapseB.onclick=()=>{
  collapseB.disabled=shuffleB.disabled=resetB.disabled=true;
  toggle();
  setTimeout(()=>collapseB.disabled=shuffleB.disabled=resetB.disabled=false,TRANS_MS);
};
shuffleB.onclick=()=>{
  shuffleB.disabled=collapseB.disabled=resetB.disabled=true;
  
  if(!collapsed){
    // Starting from fanned mode - add shuffling class to hide discard pile
    isShuffling = true;
    deckWrap.classList.add('shuffling');
    
    toggle();
    setTimeout(()=>{
      shuffleDeck(() => {
        setTimeout(()=>{
          toggle();
          // Remove shuffling class after animation completes
          isShuffling = false;
          deckWrap.classList.remove('shuffling');
          setTimeout(()=>shuffleB.disabled=collapseB.disabled=resetB.disabled=false,TRANS_MS);
        },TRANS_MS);
      });
    },TRANS_MS);
  }else{
    // Starting from collapsed mode - discard pile can stay visible
    shuffleDeck(() => {
      setTimeout(()=>shuffleB.disabled=collapseB.disabled=resetB.disabled=false,100);
    });
  }
};
/* ---- NEW Reset button ---- */
resetB.onclick=()=>resetDeck();

/* ---------- resetDeck & bootstrap ---------- */
function resetDeck(){
  const n=parseInt(numSel.value,10)||10;
  deck=Array.from({length:n},(_,i)=>i+1);
  discard=[]; // Reset discard pile
  selected.innerHTML='';
  collapsed=false; 
  tableau.classList.remove('is-collapsed');
  deckWrap.classList.remove('collapsed-mode'); // Add this line
  collapseB.textContent='Collapse';
  buildFan();
  updateCounts(); // Update discard count
}
numSel.onchange=resetDeck;

// Discard pile event listeners
pileArea.addEventListener('click', restorePile);

// Enable/disable discard functionality
enableDiscard.addEventListener('change', (e) => {
  allowDiscard = e.target.checked;
  if (!allowDiscard) {
    // Clear discard pile when disabled
    discard = [];
    updateCounts();
  }
});

new ResizeObserver(()=>{if(!collapsed) buildFan();}).observe(tableau);

// Set up discard pile background
pileStack.style.backgroundImage = `url('${IMG}')`;

// Dynamically calculate aspect ratio from the actual image, just like deck.html
const pre=new Image(); 
pre.onload=()=>{
  document.documentElement.style.setProperty('--card-aspect',pre.naturalWidth/pre.naturalHeight);
  resetDeck();
  updateCounts(); // Initialize discard count
};
pre.src=IMG;
</script>
</body>
</html>
